platform :android do
  lane :build do |options|
    load_env(env: options[:env])
    do_clean(options)

    keystore_file_path = File.join(Dir.pwd, "../android/keystores", ENV["ANDROID_KEYSTORE_FILE"])

    gradle(
      project_dir: "android/",
      task: ENV["ANDROID_BUILD_TASK"],
      build_type: ENV["ANDROID_BUILD_TYPE"],
      print_command: true,
      properties: {
        "android.injected.signing.store.file" => keystore_file_path,
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEYSTORE_ALIAS"],
        "android.injected.signing.key.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "reactNativeArchitectures" => "armeabi-v7a,arm64-v8a",
      }
    )

    # copy .apk
    if (ENV["ANDROID_BUILD_TASK"] === "assemble")
      copy_artifacts(
        artifacts: [lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]],
        target_path: ENV["OUTPUT_DIRECTORY"]
      )
    end

    # copy .aab
    if (ENV["ANDROID_BUILD_TASK"] === "bundle")
      copy_artifacts(
        artifacts: [lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]],
        target_path: ENV["OUTPUT_DIRECTORY"]
      )
    end

    # copy proguard mapping
    copy_artifacts(
      artifacts: [lane_context[SharedValues::GRADLE_MAPPING_TXT_OUTPUT_PATH]],
      target_path: ENV["OUTPUT_DIRECTORY"]
    )
  end
end

platform :ios do
  lane :build do |options|
    load_env(env: options[:env])
    do_clean(options)

    if (options[:sigh])
      run_sigh(adhoc: options[:adhoc])
    end

    gym()
  end
end
